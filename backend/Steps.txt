Database Creation
----------------------------
create database BookStoreDB
use BookStoreDB

create table Users
(uId int primary key identity(1000,1),
uFName nvarchar(50) not null,
uLName nvarchar(50) not null,
uPhone nvarchar(10) unique not null check  (uPhone like REPLICATE('[0-9]', 10)),
uMailId nvarchar(50) unique not null check (uMailId like '%_@__%.__%'),
uPassword nvarchar(50) not null  check (len([uPassword])>(5)),
uAccountStatus nvarchar(10) not null check (uAccountStatus in ('activated','deactivated')),
uRole nvarchar(10) not null check (uRole in('user','admin')))

create view LoginCredentials as
select uMailId,uPassword, uId, uRole
from Users
with check option

create table UserAddresses 
(id int identity primary key,
uId int foreign key references Users(uId),
uAddressLineOne nvarchar(100) not null,
uAddressLineTwo nvarchar(100),
uLandMark nvarchar(100),
uCity nvarchar(50) not null,
uState nvarchar(50) not null,
uCountry nvarchar(50) not null,
uPincode nvarchar(50) not null check(UPincode like REPLICATE('[0-9]', 6)))  


create table Authors 
(aId int primary key identity(100,1),
aFName nvarchar(50) not null,
aLName nvarchar(50),
aCountry nvarchar(50) not null)

create table Category 
(cId int primary key identity(200,1),
cName nvarchar(50) unique not null,
cDescription nvarchar(300) not null,
cImage nvarchar(50) not null,
cStatus nvarchar(10)not null  check (cStatus in ('activated','deactivated')),
cPosition int not null,
cCreatedAt date)

create table Books 
(bId int primary key identity(5000,1),
bName nvarchar(50) unique not null,
cId int foreign key references Category(cId),
aId int foreign key references Authors(aId),
bISBN varchar(17) not null,
bPrice float not null,
bDescription nvarchar(300)not null,
bPosition int not null, 
bStatus nvarchar(10) not null check (bStatus in ('activated','deactivated')),
bImage nvarchar(50) not null,
bQuantity int not null)

create table Coupons 
(coId int primary key,
coCode nvarchar(10) not null,
coName nvarchar(50) unique not null,
coExpiryDate date,
coDiscount float not null)

create table Orders 
(oId int primary key identity(10000,1),
uId int foreign key references Users(uId),
orDateAndTime date,
orCouponId int foreign key references Coupons(coId))

create table OrderDetails 
(ordrId int primary key identity,
oId int foreign key references Orders(oId),
uId int foreign key references Users(uId),
bId int foreign key references Books(bId),
bISBN varchar(17) not null,
bPrice float not null,
bQuantity int not null,
oTotalPrice float not null,
oShippingAddress nvarchar(250) not null,
oBillingAddress nvarchar(250) not null,
oPaymentMode nvarchar(10) not null)

create table Logs 
(lId int primary key identity,
uId int foreign key references Users(uId),
lLogType nvarchar(20),
lUserType nvarchar(10),
lDateAndTime date)



API Creation
-------------------------
ASP.NET Core Web App
Dependencies-----manage-nugets package--install
Microsoft.EntityFrameworkCore(3.1.20)
Microsoft.EntityFrameworkCore.SqlServer(3.1.20)
Microsoft.EntityFrameworkCore.Tools(3.1.20)
Microsoft.VisualStudio.Web.CodeGeneration.Design(3.1.5)

build soln
tools------nuggetmanager----pkg manager console
type:  Scaffold-DbContext "Server=IND431;Database=BookStoreDataBase;Trusted_Connection=true;" Microsoft.EntityFrameworkCore.SqlServer -o Models

add in appsettings.json:
 "ConnectionStrings": {
    "BookConStr": "Server=IND431;Database=BookStoreDB;Trusted_Connection=True;"
  },

add in startup.cs:
  public void ConfigureServices(IServiceCollection services)
        {
           
            services.AddDbContext<BookStoreDBContext>(options =>
               options.UseSqlServer(Configuration.GetConnectionString("BookConStr")));
        }

add api controller with entity framework 
add mvc controllers with entity framework

added code in global.asx for serialization error:
using System.Data.Entity;
GlobalConfiguration.Configuration.Formatters.JsonFormatter.SerializerSettings
    .ReferenceLoopHandling = Newtonsoft.Json.ReferenceLoopHandling.Ignore;
            GlobalConfiguration.Configuration.Formatters
                .Remove(GlobalConfiguration.Configuration.Formatters.XmlFormatter);

category.cs:
----------------
 [DisplayName("Upload Image")]
public string cImage { get; set; }
public HttpPostedFileBase ImageFile { get; set; }


actionresult create:
-------------------------
 if (ModelState.IsValid)
            {
                string fileName = Path.GetFileNameWithoutExtension(category.ImageFile.FileName);
                string extension= Path.GetExtension(category.ImageFile.FileName);
                fileName = fileName + DateTime.Now.ToString("yymmssfff")+extension;
                //cImage contains the path for the image
                category.cImage = "~/Images/Category/" + fileName;
                fileName = Path.Combine(Server.MapPath("~/Images/Category/"),fileName);
                category.ImageFile.SaveAs(fileName);
                using(BookStoreDBEntities db = new BookStoreDBEntities())
                {
                    db.Categories.Add(category);
                    db.SaveChanges();
                }
                return RedirectToAction("Index");

            }
            ModelState.Clear();
            return View(category);

create.cshtml:
-----------------------
  <input type="file" name="ImageFile" required />

make changes for delete and display
change item to Model

CHANGES IN CATEGORY AND BOOK MVC CONTROLLERS AND THEIR VIEWS


Jovel's edits
=============
-> Changed the schema
-> created database and tables
-> created a core api (didn't work out)
-> created a framework api(v2), used ado model, generated controllers
-> added a dummy data to user table
-> tried running api, but there's an issue while fetching data. I believe it is because we are using foreign keys.
   trying to find my way out of it.
-> added some extra functions related to converting xml to json and serialisation of data in webapiconfig file.
   The data is fetched successfully.
-> There was an issue when data was added in foreign key table (useraddresses). the issue was with lazy loading. Disabled it in context file,
   now data is working fine.
-> Need to add a cart and wishlist table
